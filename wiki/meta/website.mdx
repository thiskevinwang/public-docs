---
name: This site itself
description: Some fun facts
---

> **Warning**: This section is under construction

# Stack

- https://nextjs.org/
- https://mdxjs.com/blog/v2/
- https://github.com/serverless-nextjs/serverless-next.js
- https://docs.aws.amazon.com/cdk/api/v2/
- https://aws.amazon.com/

## Hacks

```bash showLineNumbers
2022-07-26T15:21:52.126Z 7a4c4448-ae7c-51e6-a205-1f12a6c7d568 INFO wiki/[...slug].tsx getStaticProps error Error [ERR_MODULE_NOT_FOUND]: Cannot find package 'vscode-oniguruma' imported from /Users/kevin/repos/thekevinwang.com/node_modules/@wooorm/starry-night/lib/get-oniguruma.js
at new NodeError (/var/task/chunks/5292.js:37228:5)
at packageResolve (/var/task/chunks/5292.js:38364:9)
at moduleResolve (/var/task/chunks/5292.js:38420:18)
at defaultResolve (/var/task/chunks/5292.js:38458:13)
at resolve (/var/task/chunks/5292.js:38497:12)
at getOniguruma (/var/task/chunks/5292.js:38511:24)
at createOniguruma (/var/task/chunks/5292.js:39040:25)
at createRegistry (/var/task/chunks/5292.js:39010:16)
at createStarryNight (/var/task/chunks/5292.js:38914:31)
at Function.rehypeStarryNight (/var/task/chunks/2387.js:99:64) {
code: 'ERR_MODULE_NOT_FOUND'
}
```

For ISR to work, I need to do this:

```diff filename="./node_modules/@wooorm/starry-night/lib/get-oniguruma.js"
- import fs from 'node:fs/promises'
- import {resolve} from 'import-meta-resolve'

  /** Node w/o fetch. */
  export async function getOniguruma() {
+   return await fetch('https://esm.sh/vscode-oniguruma@1/release/onig.wasm')
-   const pkgUrl = await resolve('vscode-oniguruma', import.meta.url)
-   return fs.readFile(new URL('onig.wasm', pkgUrl))
  }
```

`import.meta.url` evaluates to a local path, that is then shipped to the
regneration lambda function, which obviously doesn't work.

Here is a `postinstall` script to handle the patching from above

```bash filename="./scripts/patch-starry-night.sh"
#!/bin/sh

echo "====================="
echo "Patching Starry Night"
echo "====================="

# A string like `Tue, 02 Aug 2022 22:10:26 +0000`
d=$(date -jRu)

file_to_patch=$(pwd)/node_modules/@wooorm/starry-night/lib/get-oniguruma.js

cat <<EOF > $file_to_patch
// This file has been patched; $d
export async function getOniguruma() {
  return await fetch("https://esm.sh/vscode-oniguruma@1/release/onig.wasm");
}
EOF

# Alternatively, `cat` a file's contents over the file to be patched
# cat $(pwd)/scripts/get-oniguruma.js > $file_to_patch
```

# After introducing Mermaid Tooling

> \_projectRoot is undefined. Unable to create a BrowserFetcher.

```bash
@ingestionTime
1659502572398
@log
058050752201:/aws/lambda/TkwSlsNextStack-NextJsAppRegenerationFunction62381-NMtGlXeCiUfY
@logStream
2022/08/03/[$LATEST]7c3026d8d4ad48ff87efc496f86df081
@message
2022-08-03T04:56:05.356Z 1e8b645a-e5f4-56d9-a5ee-3f3ee7ec0c46 ERROR Invoke Error {"errorType":"Error","errorMessage":"_projectRoot is undefined. Unable to create a BrowserFetcher.","stack":["Error: _projectRoot is undefined. Unable to create a BrowserFetcher."," at resolveExecutablePath (/var/task/chunks/4545.js:86251:15)"," at ChromeLauncher.launch (/var/task/chunks/4545.js:85667:53)"," at async transformer (/var/task/pages/wiki/[...slug].js:345:25)"]}
@requestId
1e8b645a-e5f4-56d9-a5ee-3f3ee7ec0c46
@timestamp
1659502565356
errorMessage
_projectRoot is undefined. Unable to create a BrowserFetcher.
errorType
Error
stack.0
Error: _projectRoot is undefined. Unable to create a BrowserFetcher.
stack.1
at resolveExecutablePath (/var/task/chunks/4545.js:86251:15)
stack.2
at ChromeLauncher.launch (/var/task/chunks/4545.js:85667:53)
stack.3
at async transformer (/var/task/pages/wiki/[...slug].js:345:25)
```

```typescript filename="regeneration-lambda/chunks/4545.js"
function resolveExecutablePath(launcher) {
  const { product, _isPuppeteerCore, _projectRoot, _preferredRevision } = launcher;
  //......
  if (!_projectRoot) {
    throw new Error(
      "_projectRoot is undefined. Unable to create a BrowserFetcher."
    );
  }
```

```typescript filename="regeneration-lambda/chunks/4545.js"
        else if (!chromeExecutable) {
            const { missingText, executablePath } = resolveExecutablePath(this);
            if (missingText) {
                throw new Error(missingText);
            }
            chromeExecutable = executablePath;
        }
```

```typescript filename="regeneration-lambda/chunks/4545.js" showLineNumbers=86279
/**
 * @internal
 */
function createLauncher(
  projectRoot,
  preferredRevision,
  isPuppeteerCore,
  product = "chrome"
) {
  switch (product) {
    case "firefox":
      return new FirefoxLauncher(
        projectRoot,
        preferredRevision,
        isPuppeteerCore
      );
    case "chrome":
      return new ChromeLauncher(
        projectRoot,
        preferredRevision,
        isPuppeteerCore
      );
  }
}
```

So I need to install chrome on my lambda

Google: install google chrome on lambda

1. https://stackoverflow.com/questions/58876521/how-to-install-chrome-inside-aws-lambda
2. https://www.npmjs.com/package/chrome-aws-lambda

```bash
npm i chrome-aws-lambda --workspace packages/application
```

ensure the right version of puppeteer is installed

... an older `mermaid.cli` package used a very old `1.20.*` version of puppeteer,
which didn't have `replaceAll` defined.

686378 (78.0.3882.0) https://chromium.googlesource.com/chromium/src/+/19d4547535ab5aba70b4730443f84e8153052174
